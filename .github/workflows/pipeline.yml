name: CI/CD Pipeline para Despliegue en Vercel

# Disparadores del pipeline
on:
  push:
    branches:
      - main  # Despliegue a Producci贸n al hacer push a main
  pull_request:
    branches:
      - main  # Despliegue de Previsualizaci贸n (Preview) en cada PR

jobs:
  ci_validation:
    name: И CI - Instalaci贸n y Pruebas
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout del C贸digo
        uses: actions/checkout@v4

      # 2. Configurar Python 3.11 (Se elimina el paso de Node.js)
      - name: 2. Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: 3. Instalar Dependencias de Python
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: 4. Ejecutar Pruebas (Validaci贸n RF6)
        run: |
          echo "Buscando pruebas unitarias..."
          # Verifica si existe alg煤n archivo de prueba con el patr贸n Pytest
          if git ls-files -- 'tests/**/test_*.py' 'test_*.py' | grep -q .; then
            echo "Tests encontrados. Ejecutando pytest..."
            # Ejecuta el comando simple, asumiendo que ya instal贸 Pytest
            pytest
          else
            echo "No se encontraron tests. Saltando pytest para permitir el despliegue (CD)."
          fi

      - name: 5. Construir el Proyecto (Opcional para Python Serverless)
        run: echo "Build de Python omitido/personalizado para Vercel."
        
  deploy_cd:
    name:  CD - Despliegue en Vercel
    runs-on: ubuntu-latest
    
    # Se ejecuta solo si las pruebas de Python pasan
    needs: ci_validation 
    
    steps:
      - name: 1. Checkout del C贸digo
        uses: actions/checkout@v4
        
      - name: 2. Despliegue Automatizado a Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          # El argumento --prod se a帽ade SLO si la rama es 'main'
        env:
          VERCEL_PROJECT_NAME: proyecto-semestral
          vercel-args: ${{ github.ref == 'refs/heads/main' && '--prod --yes' || '--yes' }}