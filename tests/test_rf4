import sqlite3
import pytest
from pathlib import Path
from datetime import datetime
from unittest.mock import MagicMock
from factura import emitir_factura

@pytest.fixture
def setup_db():
    """Crea una base de datos SQLite en memoria con una orden lista para facturar."""
    conn = sqlite3.connect(':memory:') 
    cursor = conn.cursor()


    cursor.execute("CREATE TABLE ordenes_compra (id TEXT PRIMARY KEY, total REAL, estado TEXT)")
    cursor.execute("CREATE TABLE facturas (id INTEGER PRIMARY KEY, orden_id TEXT, fecha_emision TEXT, monto_neto REAL, monto_iva REAL, monto_total REAL, estado_envio TEXT)")


    cursor.execute("INSERT INTO ordenes_compra VALUES ('ORD-001', 100.00, 'OC_CREADA')")
    conn.commit()
    
    yield conn # Retorna la conexi贸n para ser usada en el test
    conn.close()


#Test

def test_emision_factura_exitosa(setup_db, monkeypatch):
    """
    Verifica que la funci贸n emitir_factura registre la factura
    y actualice el estado de la orden a 'FACTURADA' (RF4).
    """
    
    # 1. Simular la entrada del usuario ('input') para la orden 'ORD-001'
    monkeypatch.setattr('builtins.input', lambda _: 'ORD-001')
    
    # 2. Ejecutar la funci贸n con la DB temporal
    emitir_factura(setup_db)
    
    # 3. VERIFICAR RESULTADOS EN LA DB
    cursor = setup_db.cursor()
    
    # A. La orden debe cambiar a estado 'FACTURADA'
    cursor.execute("SELECT estado FROM ordenes_compra WHERE id = 'ORD-001'")
    estado_final = cursor.fetchone()[0]
    assert estado_final == 'FACTURADA'
    
    # B. Debe existir una nueva factura
    cursor.execute("SELECT monto_total FROM facturas WHERE orden_id = 'ORD-001'")
    factura = cursor.fetchone()
    
    assert factura is not None, "Error: No se encontr贸 la factura en la base de datos."
    assert factura[0] == 119.00 # 100 (neto) + 19 (IVA) = 119.00 total